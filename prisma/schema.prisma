// @nimbalyst {"viewport":{"x":476.43142888090654,"y":160.91926970163954,"zoom":0.6023450763201056},"positions":{"Household":{"x":-500,"y":-340},"HouseholdMember":{"x":420,"y":-200},"PlaidItem":{"x":1640,"y":-20},"Account":{"x":1000,"y":-680},"Transaction":{"x":-620,"y":60},"CardProduct":{"x":360,"y":220},"CardBenefit":{"x":800,"y":400},"BenefitDetectionRule":{"x":1160,"y":220},"CardInstance":{"x":100,"y":1120},"CardInstanceConfig":{"x":450,"y":700},"CreditUsage":{"x":1180,"y":880},"SpendingSummary":{"x":-360,"y":820}},"entityViewMode":"standard"}

generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "sqlite"
}

model Household {
  id        String            @id @default(cuid())
  name      String
  createdAt DateTime          @default(now())
  members   HouseholdMember[]
}

model HouseholdMember {
  id          String   @id @default(cuid())
  householdId String
  name        String
  /// "owner" | "partner"
  role        String
  createdAt   DateTime @default(now())

  household         Household          @relation(fields: [householdId], references: [id])
  plaidItems        PlaidItem[]
  accounts          Account[]
  transactions      Transaction[]
  cardInstances     CardInstance[]
  spendingSummaries SpendingSummary[]
}

model PlaidItem {
  id                String   @id @default(cuid())
  householdMemberId String
  /// encrypted at rest
  accessToken       String
  itemId            String   @unique
  institutionId     String?
  institutionName   String?
  /// "active" | "needs_reauth" | "revoked"
  status            String   @default("active")
  /// for transactions/sync incremental sync
  syncCursor        String?
  lastSynced        DateTime?
  createdAt         DateTime @default(now())

  householdMember HouseholdMember @relation(fields: [householdMemberId], references: [id])
  accounts        Account[]
}

model Account {
  id               String  @id @default(cuid())
  plaidItemId      String
  householdMemberId String
  plaidAccountId   String  @unique
  name             String
  officialName     String?
  /// "checking" | "savings" | "credit" | "investment" | "other"
  type             String
  subtype          String?
  /// last 4 digits
  mask             String?
  currentBalance   Float?
  availableBalance Float?
  /// links credit card accounts to a CardInstance
  cardInstanceId   String?

  householdMember HouseholdMember @relation(fields: [householdMemberId], references: [id])
  plaidItem       PlaidItem       @relation(fields: [plaidItemId], references: [id])
  cardInstance    CardInstance?   @relation(fields: [cardInstanceId], references: [id])
  transactions    Transaction[]
}

model Transaction {
  id                  String   @id @default(cuid())
  accountId           String
  householdMemberId   String
  plaidTransactionId  String   @unique
  date                DateTime
  /// positive = money out (debit), negative = money in (credit)
  amount              Float
  /// original amount from Plaid (preserved when user edits amount)
  originalAmount      Float?
  isoCurrencyCode     String?  @default("USD")
  /// raw from Plaid
  originalName        String
  /// from LLM categorization
  cleanMerchantName   String?
  /// true if user manually edited cleanMerchantName
  userEditedName      Boolean  @default(false)
  merchantLogo        String?
  /// Plaid's categorization (JSON)
  plaidCategory       String?
  plaidCategoryId     String?
  /// our standardized category
  category            String?
  subcategory         String?
  /// LLM's original category suggestion (preserved when user overrides)
  llmCategory         String?
  /// LLM's original subcategory suggestion (preserved when user overrides)
  llmSubcategory      String?
  /// 0-1
  categoryConfidence  Float?
  /// "plaid" | "llm" | "user"
  categorySource      String?
  pending             Boolean  @default(false)
  excludeFromTotals   Boolean  @default(false)
  /// true if this transaction has been split; excluded from totals when true
  hasSplits           Boolean  @default(false)
  transactionGroupId  String?
  createdAt           DateTime @default(now())

  householdMember  HouseholdMember          @relation(fields: [householdMemberId], references: [id])
  account          Account                  @relation(fields: [accountId], references: [id])
  transactionGroup TransactionGroup?        @relation(fields: [transactionGroupId], references: [id])
  splits           TransactionSplit[]
  creditUsageLinks CreditUsageTransaction[]
}

model TransactionGroup {
  id           String        @id @default(cuid())
  /// user-provided label, e.g., "Hotel stay Feb 2026"
  name         String
  notes        String?
  createdAt    DateTime      @default(now())
  transactions Transaction[]
}

model TransactionSplit {
  id            String   @id @default(cuid())
  transactionId String
  amount        Float
  category      String
  subcategory   String?
  notes         String?
  createdAt     DateTime @default(now())

  transaction Transaction @relation(fields: [transactionId], references: [id])
}

model CardProduct {
  id           String   @id @default(cuid())
  name         String
  /// "amex" | "chase" | "citi" | "apple"
  issuer       String
  annualFee    Float
  /// "calendar" | "anniversary"
  feeResetType String   @default("calendar")
  productUrl   String?

  benefits      CardBenefit[]
  cardInstances CardInstance[]
}

model CardBenefit {
  id                   String    @id @default(cuid())
  cardProductId        String
  name                 String
  description          String?
  /// total annual value in dollars
  annualValue          Float
  /// amount per reset period
  periodValue          Float
  /// "monthly" | "quarterly" | "semi-annual" | "annual" | "multi-year"
  resetPeriod          String
  /// "calendar" | "cardmember-anniversary" | "custom-dates"
  resetType            String    @default("calendar")
  /// "auto-detect" | "reminder"
  trackingMode         String
  requiresEnrollment   Boolean   @default(false)
  enrollmentUrl        String?
  /// for time-limited benefits
  expiresAt            DateTime?
  active               Boolean   @default(true)
  /// human-readable notes
  notes                String?
  /// e.g., Equinox credit -- household doesn't use it
  notApplicable        Boolean   @default(false)

  cardProduct    CardProduct          @relation(fields: [cardProductId], references: [id])
  detectionRules BenefitDetectionRule[]
  creditUsages   CreditUsage[]
}

model BenefitDetectionRule {
  id                               String  @id @default(cuid())
  cardBenefitId                    String
  /// "merchant-name" | "merchant-category" | "amount-match" | "custom"
  ruleType                         String
  /// JSON array -- e.g., '["Saks Fifth Avenue", "SAKS", "saks.com"]'
  merchantNames                    String?
  /// JSON array -- e.g., '["dining", "restaurants"]'
  merchantCategories               String?
  amountMin                        Float?
  amountMax                        Float?
  /// JSON array of regex patterns
  transactionDescriptionPatterns   String?
  notes                            String?

  cardBenefit CardBenefit @relation(fields: [cardBenefitId], references: [id])
}

model CardInstance {
  id             String    @id @default(cuid())
  cardProductId  String
  householdMemberId String
  activationDate DateTime?
  renewalDate    DateTime?
  nickname       String?
  createdAt      DateTime  @default(now())

  householdMember HouseholdMember     @relation(fields: [householdMemberId], references: [id])
  cardProduct     CardProduct         @relation(fields: [cardProductId], references: [id])
  accounts        Account[]
  configs         CardInstanceConfig[]
  creditUsages    CreditUsage[]
}

model CardInstanceConfig {
  id             String @id @default(cuid())
  cardInstanceId String
  /// e.g., "selected_airline"
  configKey      String
  /// e.g., "united"
  configValue    String

  cardInstance CardInstance @relation(fields: [cardInstanceId], references: [id])
}

model CreditUsage {
  id              String   @id @default(cuid())
  cardBenefitId   String
  cardInstanceId  String
  periodStart     DateTime
  periodEnd       DateTime
  /// how much of the credit was used
  amount          Float
  /// "pending-confirmation" | "confirmed" | "dismissed" | "auto-confirmed"
  status          String   @default("pending-confirmation")
  /// "auto" | "manual"
  detectionMethod String   @default("auto")
  confirmedAt     DateTime?
  notes           String?
  createdAt       DateTime @default(now())

  cardBenefit  CardBenefit            @relation(fields: [cardBenefitId], references: [id])
  cardInstance CardInstance           @relation(fields: [cardInstanceId], references: [id])
  transactions CreditUsageTransaction[]
}

model CreditUsageTransaction {
  id            String @id @default(cuid())
  creditUsageId String
  transactionId String

  creditUsage CreditUsage @relation(fields: [creditUsageId], references: [id])
  transaction Transaction @relation(fields: [transactionId], references: [id])

  @@unique([creditUsageId, transactionId])
}

model SpendingSummary {
  id                String  @id @default(cuid())
  /// null = household-wide
  householdMemberId String?
  category          String
  subcategory       String?
  year              Int
  month             Int
  totalAmount       Float
  transactionCount  Int

  householdMember HouseholdMember? @relation(fields: [householdMemberId], references: [id])
}

model EditHistory {
  id         String   @id @default(cuid())
  /// "transaction" | "credit-usage" | "card-instance-config"
  entityType String
  entityId   String
  /// which field was changed
  field      String
  /// JSON-encoded previous value
  oldValue   String?
  /// JSON-encoded new value
  newValue   String?
  editedAt   DateTime @default(now())
}
